# DataRobot Notebook Admin Viewer - Implementation Documentation

## Project Overview

A web-based admin tool for viewing and managing DataRobot Notebooks and Codespaces across all use cases. Built with Bun, React, TypeScript, and shadcn/ui components.

## What We Built

### 1. Backend (Bun Server)

**File: `index.ts`**
- Implemented `Bun.serve()` server with routes configuration
- Created `/api/notebooks` endpoint that:
  - Fetches all use cases from DataRobot API
  - Fetches all notebooks for all use cases
  - Enriches notebook data with use case names
  - Implements 5-minute caching to reduce API calls
  - Returns aggregated data with counts (total, codespace count, notebook count)
- Configured 120-second timeout for long-running API requests

### 2. Frontend (React + TypeScript)

#### Main Components

**`src/App.tsx`**
- Root application component
- Manages data fetching from `/api/notebooks` endpoint
- Handles three filter states: Codespaceのみ, 1ヶ月以上未使用, 使用中
- Implements client-side filtering logic
- Shows loading state with morphing square animation

**`src/components/NotebooksTable.tsx`**
- Data table using TanStack React Table
- 10 columns with Japanese labels:
  - UC名 (Use Case Name)
  - 名前 (Name)
  - タイプ (Type)
  - ステータス (Status)
  - 編集日時 (Updated At)
  - 編集者 (Editor)
  - 作成時間 (Created At)
  - 作成者 (Creator)
  - 定期実行 (Has Schedule)
  - 定期実行有効 (Has Enabled Schedule)
- All columns sortable (sorts full dataset, not just current page)
- Pagination at 100 items per page
- Date formatting to YYYY-MM-DD
- Boolean formatting to はい/いいえ
- Copy/Download button group (shadcn ButtonGroup) exports the current page as CSV, adding `UC名_link` and `名前_link` columns and showing transient "Copied" feedback

**`src/components/CountDisplay.tsx`**
- Static count display (not affected by filters)
- Shows:
  - Codespace合計: [count of type=codespace]
  - Notebook+Codespace合計: [total count]

**`src/components/FilterCheckboxes.tsx`**
- Three filter checkboxes with Japanese labels:
  1. **Codespaceのみ**: Filters to show only items where `type === "codespace"`
  2. **1ヶ月以上未使用**: Filters items where `updated.at` is more than 30 days old
  3. **使用中**: Filters to show only items where `session.status === "running"`
- Filters are cumulative (AND logic)

**`src/components/ui/loading.tsx`**
- Morphing square loading animation component

### 3. Data Layer

**`src/api/datarobot.ts`**
- Updated TypeScript interfaces to match actual API response:
  - `Notebook` - Full notebook/codespace structure
  - `NotebookUser` - User information (username, firstName, lastName)
  - `NotebookTimestamp` - Timestamp with user info
  - `NotebookSession` - Session status and details
  - `UseCase` - Use case metadata

**`src/types/notebook.ts`**
- Frontend-specific types
- `NotebooksResponse` - API response structure

### 4. Styling

**Tailwind CSS v4 Pipeline:**
- `src/styles/globals.css` - Base styles with CSS variables plus `@import "tailwindcss";` and `@source` directives
- `src/styles/tailwind.css` - Generated by `@tailwindcss/cli`; gitignored and rebuilt automatically
- `scripts/dev.ts` - Orchestrates an initial Tailwind build, starts the watcher (`--watch`), then launches the Bun dev server with HMR
- `tailwindcss -i ./src/styles/globals.css -o ./src/styles/tailwind.css --minify` - Production build script (invoked via `bun run tailwind:build`)

**shadcn/ui Components:**
- Button (`src/components/ui/button.tsx`)
- Checkbox (`src/components/ui/checkbox.tsx`)
- Table components (`src/components/ui/table.tsx`)

## Implementation Steps

### Phase 1: Data Export
1. Modified `index.ts` to export notebook and use case data to JSON files
2. Analyzed data structure to understand all available fields
3. Identified missing fields in TypeScript interfaces

### Phase 2: Project Setup
1. Installed React and React DOM with TypeScript types
2. Installed Tailwind CSS v4 with the official CLI package
3. Installed Radix UI primitives (@radix-ui/react-checkbox, @radix-ui/react-slot)
4. Installed table utilities (@tanstack/react-table)
5. Installed utility libraries (clsx, tailwind-merge, class-variance-authority, lucide-react)

### Phase 3: Configuration
1. Created `components.json` for shadcn configuration
2. Updated `tsconfig.json` with path aliases and DOM types
3. Added Tailwind v4 CLI scripts to `package.json` (build + dev orchestration)
4. Added `scripts/dev.ts` to coordinate the Tailwind watcher and Bun server
5. Ignored the generated `src/styles/tailwind.css` in `.gitignore`

### Phase 4: Component Development
1. Created TypeScript interfaces matching API responses
2. Built UI components (Button, Checkbox, Table, Loading)
3. Implemented CountDisplay component
4. Implemented FilterCheckboxes component
5. Implemented NotebooksTable with sorting and pagination
6. Built main App component with data fetching and filtering logic

### Phase 5: Server Implementation
1. Converted `index.ts` from CLI script to Bun.serve server
2. Implemented routes configuration with HTML bundle serving
3. Created `/api/notebooks` GET endpoint
4. Added data caching with 5-minute TTL
5. Implemented use case name enrichment

### Phase 6: Styling & Testing
1. Ran `tailwindcss -i ./src/styles/globals.css -o ./src/styles/tailwind.css --minify` to generate the bundle
2. Updated App.tsx to import compiled CSS
3. Tested all features in Chrome DevTools:
   - Data loading ✅
   - Filter functionality (Codespaceのみ) ✅
   - Sorting (名前 column) ✅
   - Count display (static) ✅
   - Pagination ✅

### Phase 7: DataRobot Deployment Optimization
1. **Build System for Proxy Compatibility**
   - Created `scripts/build.ts` using `Bun.build()` with `publicPath: './'`
   - Generates relative asset paths (`./chunk-*.css`) instead of absolute paths (`/_bun/asset/`)
   - Outputs to `dist/` directory with bundled and minified assets
   - Updated `package.json` with `build` script

2. **Server Architecture for Production**
   - Split server configuration into development and production modes
   - Development: Uses `routes` with HTMLBundle for HMR
   - Production: Uses `fetch` handler to serve from `./dist`
   - Changed API path from `/api/notebooks` to `./api/notebooks` (relative)

3. **Environment Variable Management**
   - Updated `start-app.sh` to load `.env` file at runtime
   - Overrides DataRobot's restricted API token with full-permission token
   - Added debug logging to verify token loading

4. **Deployment Scripts**
   - Updated `build-app.sh` to run `bun run build` (not just Tailwind)
   - Updated `start-app.sh` to:
     - Load `.env` environment variables
     - Start server without rebuild (build happens during Docker build)
   - Added environment variable debugging output

## DataRobot Deployment Architecture

### Proxy Compatibility Challenge

**Problem:**
- DataRobot serves apps at `/custom_applications/<ID>/`
- Bun's default bundler generates absolute paths: `/_bun/asset/xyz.css`
- Browser requests: `https://app.datarobot.com/_bun/asset/xyz.css` (404 error)
- Should be: `https://app.datarobot.com/custom_applications/<ID>/chunk-xyz.css`

**Solution:**
Used `Bun.build()` with `publicPath: './'` to generate relative paths:
```typescript
// scripts/build.ts
await Bun.build({
  entrypoints: ['./index.html'],
  outdir: './dist',
  publicPath: './',  // Generate relative paths
  minify: true,
});
```

**Result:**
- `dist/index.html` contains: `<script src="./chunk-xyz.js">`
- Browser resolves relative to current page URL
- Works at any base path (local dev or DataRobot proxy)

### API Path Compatibility

**Problem:**
- Frontend API call: `fetch("/api/notebooks")`
- Behind proxy resolves to: `https://app.datarobot.com/api/notebooks` (wrong!)
- Should be: `https://app.datarobot.com/custom_applications/<ID>/api/notebooks`

**Solution:**
Changed to relative path in `src/App.tsx`:
```typescript
// Before
const response = await fetch("/api/notebooks");

// After
const response = await fetch("./api/notebooks");
```

### Environment Variable Override

**Problem:**
- DataRobot runtime provides `DATAROBOT_API_TOKEN` automatically
- This token has restricted permissions (cannot read use cases/notebooks)
- API requests fail with 401 Unauthorized

**Solution:**
Load full-permission token from `.env` file in `start-app.sh`:
```bash
# Load .env file uploaded via Pulumi
if [ -f .env ]; then
  set -a        # Auto-export variables
  . ./.env      # Source file
  set +a        # Turn off auto-export
fi
```

**Flow:**
1. Container starts with restricted `DATAROBOT_API_TOKEN`
2. `start-app.sh` loads `.env` file
3. Full-permission token overrides restricted token
4. Application can access required APIs

### Server Mode Switching

**Development Mode:**
```typescript
Bun.serve({
  routes: {
    "/": indexHtml,  // HTMLBundle for HMR
    "/api/notebooks": { GET: handler }
  },
  development: { hmr: true }
});
```

**Production Mode:**
```typescript
Bun.serve({
  fetch(req) {
    // Serve static files from ./dist
    const file = Bun.file(path.join("./dist", filePath));
    return new Response(file);
  }
});
```

## Technical Decisions

### Why Bun?
- Built-in TypeScript support
- Native HTML imports for React components
- Fast bundler with HMR (Hot Module Reloading)
- `Bun.build()` API with `publicPath` configuration
- Simple serve configuration with routes
- Project requirement (specified in CLAUDE.md)

### Why Tailwind CSS v4?
- Single-file `@import "tailwindcss";` setup aligned with Bun bundler
- CLI-driven builds that tree-shake utilities on every compile
- Works seamlessly with shadcn/ui while removing the need for bespoke config files

### Why TanStack React Table?
- Powerful sorting and pagination features
- Full TypeScript support
- Flexible API for custom rendering
- Sorts entire dataset (not just current page)

### Why Client-Side Filtering?
- Dataset is small (42 items)
- Faster user experience (no server round-trip)
- Simpler implementation
- Server provides enriched data once

## File Structure

```
dr-nb-admin-viewer/
├── index.ts                          # Bun server + API endpoint
├── index.html                        # HTML entry point
├── package.json                      # Dependencies & scripts
├── components.json                   # shadcn configuration
├── scripts/
│   └── dev.ts                        # Tailwind watcher + Bun dev server launcher
├── tsconfig.json                     # TypeScript configuration
├── src/
│   ├── App.tsx                       # Main React component
│   ├── frontend.tsx                  # React root renderer
│   ├── types/
│   │   └── notebook.ts               # Frontend types
│   ├── components/
│   │   ├── NotebooksTable.tsx        # Data table component
│   │   ├── FilterCheckboxes.tsx      # Filter controls
│   │   ├── CountDisplay.tsx          # Count display
│   │   └── ui/
│   │       ├── button.tsx            # Button component
│   │       ├── checkbox.tsx          # Checkbox component
│   │       ├── table.tsx             # Table components
│   │       └── loading.tsx           # Loading animation
│   ├── lib/
│   │   └── utils.ts                  # Utility functions (cn)
│   ├── styles/
│   │   ├── globals.css               # Source CSS with Tailwind import + @source directives
│   │   └── tailwind.css              # Generated CSS bundle (gitignored)
│   └── api/
│       ├── datarobot.ts              # DataRobot API client
│       └── datarobot.test.ts         # API tests
├── infra/
│   ├── custom_environment/
│   │   └── Dockerfile                # Bun runtime container definition
│   ├── custom_application/
│   │   ├── build-app.sh              # Build script (installs deps, builds CSS)
│   │   └── start-app.sh              # Start script (launches Bun server)
│   └── __main__.py                   # Pulumi infrastructure program
├── quickstart.py                     # Deployment runner script
├── requirements.txt                  # Python/Pulumi dependencies
├── reference/
│   ├── mockup.png                    # Design mockup
│   ├── notebooks-data.json           # Exported notebook data
│   └── usecases-data.json            # Exported use case data
└── docs/
    ├── IMPLEMENTATION.md             # This file
    └── DEPLOYMENT.md                 # DataRobot deployment guide
```

## Usage

### Development

```bash
# Start the Tailwind watcher + Bun dev server (auto-compiles on change)
bun run dev

# Access at http://localhost:8080 (or http://0.0.0.0:8080)
```

### Production

```bash
# Compile CSS bundle and launch the server
bun run start
```

### Scripts

- `bun run tailwind:build` - One-off Tailwind CSS build (minified output)
- `bun run build` - Build Tailwind CSS + frontend assets with `publicPath: './'`
- `bun run dev` - Runs Tailwind watcher and Bun dev server (development mode with HMR)
- `bun run start` - Builds assets then starts production server (serves from `./dist`)
- `bun test` - Run tests

## Features

### ✅ Implemented

1. **Data Table**
   - 10 columns with Japanese labels
   - All columns sortable
   - 100 items per page
   - Date formatting (YYYY-MM-DD)
   - Boolean formatting (はい/いいえ)

2. **Count Display** (Static)
   - Codespace合計: [count]
   - Notebook+Codespace合計: [count]

3. **Filters** (Cumulative)
   - Codespaceのみ
   - 1ヶ月以上未使用
   - 使用中

4. **UI/UX**
   - Modern shadcn design
   - Morphing square loading animation
   - Responsive layout
   - Hover states on table rows
   - Disabled state for pagination buttons

5. **CSV Export Controls**
   - Copy and download buttons above the table
   - CSV includes additional `UC名_link` and `名前_link` columns when URLs exist
   - Copy action shows temporary "Copied" state for feedback

6. **Backend**
   - RESTful API endpoint
   - 5-minute data caching
   - Use case name enrichment
   - Error handling

## Environment Setup

Required environment variables in `.env`:
```bash
DATAROBOT_API_TOKEN=your_full_permission_token
DATAROBOT_ENDPOINT=https://app.datarobot.com/api/v2
```

**Critical Requirements:**
- Token must have permissions to read use cases and notebooks
- When deploying to DataRobot, this `.env` file is uploaded via Pulumi
- `start-app.sh` loads `.env` to override restricted runtime token
- Without this override, API requests fail with 401 Unauthorized

## API Response Structure

```typescript
{
  total: number;              // Total count of all notebooks + codespaces
  codespaceCount: number;     // Count of type === "codespace"
  notebookCount: number;      // Count of type === "notebook"
  data: Notebook[];          // Array of enriched notebooks
}
```

Each notebook includes:
- Basic info: id, name, type, description
- Use case: useCaseId, useCaseName (enriched)
- Timestamps: created, updated (with user info)
- Session: status, startedAt (if exists)
- Scheduling: hasSchedule, hasEnabledSchedule

## Known Limitations

1. **Cache Duration**: 5 minutes - may show stale data
2. **No Real-time Updates**: Requires page refresh to see new data
3. **Client-Side Filtering**: All data loaded upfront
4. **No Sorting Persistence**: Sort state resets on page reload
5. **No Filter Persistence**: Filter state resets on page reload

## Future Enhancements (Not Implemented)

- [ ] Server-side filtering and pagination
- [ ] Real-time data updates via WebSocket
- [ ] Export to Excel (CSV export via copy/download is implemented)
- [ ] Advanced search functionality
- [ ] User preferences persistence
- [ ] Bulk operations (delete, stop sessions)
- [ ] Session management (start/stop)
- [ ] Audit log viewer

## Troubleshooting

### CSS not applying?
```bash
bun run tailwind:build
```

### Server timeout on first load?
The first request fetches all data from DataRobot API and can take 15-20 seconds. Subsequent requests use cached data (5-minute TTL).

### Port 8080 already in use?
```bash
# Inspect process on port 8080
lsof -nP -iTCP:8080 -sTCP:LISTEN

# After confirming, terminate the process
lsof -ti:8080 | xargs kill -9
```

## Dependencies

### Runtime
- react: ^19.2.0
- react-dom: ^19.2.0
- @tanstack/react-table: ^8.21.3
- @radix-ui/react-checkbox: ^1.3.3
- @radix-ui/react-slot: ^1.2.3
- lucide-react: ^0.546.0
- clsx: ^2.1.1
- tailwind-merge: ^3.3.1
- class-variance-authority: ^0.7.1

### Development
- @tailwindcss/cli: ^4.1.16
- @types/bun: latest
- @types/react: ^19.2.2
- @types/react-dom: ^19.2.2
- typescript: ^5
- tailwindcss: ^4.1.15

### Deployment (Python)
- pulumi: ^3.187.0
- pulumi-datarobot: ^0.10.13
- datarobot-pulumi-utils: ^0.0.2.post16

## DataRobot Deployment

This application can be deployed to the DataRobot platform as a Custom Application using Pulumi Infrastructure as Code.

### Architecture

**Deployment Stack:**
- **Python + Pulumi**: Infrastructure/deployment tooling (isolated to deployment only)
- **Bun Runtime**: Application execution in DataRobot containers
- **Docker**: Custom execution environment with Bun

### Quick Deploy

```bash
# Prerequisites: Python 3.9+, Pulumi CLI installed
python quickstart.py <stack-name>
```

This will:
1. Create Python virtual environment
2. Install Pulumi dependencies
3. Build custom Docker image with Bun runtime
4. Package and upload application source
5. Create DataRobot Custom Application
6. Output application URL

### Infrastructure Components

**1. Custom Execution Environment** (`infra/custom_environment/Dockerfile`)
- Base: `oven/bun:1-debian`
- Port: 8080 (DataRobot standard)
- No additional system dependencies needed

**2. Build Script** (`infra/custom_application/build-app.sh`)
```bash
bun install
bun run tailwind:build
```

**3. Start Script** (`infra/custom_application/start-app.sh`)
```bash
exec bun run start  # Launches Bun server
```

**4. Pulumi Program** (`infra/__main__.py`)
- Creates execution environment from Dockerfile
- Packages source code (excludes: .venv, node_modules, .git, reference/)
- Configures resources (CPU_8XL, 1 replica, session affinity)
- Creates Custom Application

### Environment Variables

Required in `.env`:
```
DATAROBOT_API_TOKEN=your_token
DATAROBOT_ENDPOINT=https://app.datarobot.com/api/v2
PULUMI_ACCESS_TOKEN=your_token  # Optional for local deployment
```

DataRobot provides these at runtime:
- `DATAROBOT_API_TOKEN` - API authentication
- `DATAROBOT_ENDPOINT` - API endpoint URL
- `PORT` - Server port (always 8080)

### Deployment Workflow

1. **Local Development**: `bun run dev`
2. **Test Build**: `./infra/custom_application/build-app.sh`
3. **Deploy**: `python quickstart.py <stack-name>`
4. **Update**: Re-run `python quickstart.py <stack-name>`
5. **Destroy**: `python quickstart.py <stack-name> --action destroy`

### File Exclusions

Automatically excluded from deployment package:
- `.venv/` - Python virtual environment
- `node_modules/` - Dependencies (reinstalled during build)
- `.git/` - Git metadata
- `reference/` - Reference data
- `.env` - Local secrets
- All Python cache and build artifacts

### CI/CD Integration

Store secrets in GitHub:
- `DATAROBOT_API_TOKEN`
- `DATAROBOT_ENDPOINT`
- `PULUMI_ACCESS_TOKEN`

Deploy via GitHub Actions:
```yaml
- name: Deploy to DataRobot
  env:
    DATAROBOT_API_TOKEN: ${{ secrets.DATAROBOT_API_TOKEN }}
    DATAROBOT_ENDPOINT: ${{ secrets.DATAROBOT_ENDPOINT }}
    PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  run: python quickstart.py prod
```

### Documentation

For comprehensive deployment guide, see [docs/DEPLOYMENT.md](./DEPLOYMENT.md):
- Prerequisites and setup
- Detailed deployment steps
- Troubleshooting common issues
- Security best practices
- Monitoring and logs

## License

Private project - All rights reserved
